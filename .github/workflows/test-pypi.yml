# å‘å¸ƒåˆ° Test-PyPI æµ‹è¯•ç¯å¢ƒ
# 
# è§¦å‘æ¡ä»¶: æ¨é€ä»»ä½•ä»¥ v å¼€å¤´çš„ tag (å¦‚ v0.2.0, v0.2.0-dev1 ç­‰)
#
# æ‰€æœ‰ tag æ¨é€éƒ½ä¼šå‘å¸ƒåˆ° Test-PyPIï¼Œæ­£å¼ç‰ˆéœ€è¦æ‰‹åŠ¨åˆ›å»º GitHub Release æ‰ä¼šå‘å¸ƒåˆ° PyPI
#
# ä½¿ç”¨æ–¹æ³•:
#   1. ä¿®æ”¹ pyproject.toml ä¸­çš„ç‰ˆæœ¬å·
#   2. git commit -m "chore: bump version to x.x.x"
#   3. git tag vx.x.x
#   4. git push && git push --tags
#   â†’ è‡ªåŠ¨æµ‹è¯•å¹¶å‘å¸ƒåˆ° Test-PyPI

name: Publish to Test-PyPI

on:
  push:
    tags:
      - 'v*'  # åŒ¹é…æ‰€æœ‰ v å¼€å¤´çš„ tag

permissions:
  contents: read

# é˜²æ­¢å¤šä¸ªå‘å¸ƒåŒæ—¶è¿è¡Œ
concurrency:
  group: test-pypi-publish
  cancel-in-progress: false

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: å®‰è£… uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true

      - name: å®‰è£… rclone
        run: |
          curl https://rclone.org/install.sh | sudo bash
          rclone version

      - name: å®‰è£… fhash
        run: |
          FHASH_VERSION=$(curl -s https://api.github.com/repos/Virace/fast-hasher/releases/latest | grep -oP '"tag_name": "\K[^"]+')
          echo "å®‰è£… fhash ${FHASH_VERSION}"
          sudo curl -L "https://github.com/Virace/fast-hasher/releases/download/${FHASH_VERSION}/fhash-linux-amd64" -o /usr/local/bin/fhash
          sudo chmod +x /usr/local/bin/fhash
          fhash -v

      - name: å®‰è£…ä¾èµ–
        run: uv sync --group dev

      - name: è¿è¡Œæµ‹è¯•
        run: uv run pytest -v

  publish:
    needs: test
    runs-on: ubuntu-latest
    environment:
      name: testpypi
      url: https://test.pypi.org/project/grimoirevfs/

    steps:
      - uses: actions/checkout@v4

      - name: å®‰è£… uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true

      - name: æ˜¾ç¤ºç‰ˆæœ¬ä¿¡æ¯
        run: |
          TAG="${{ github.ref_name }}"
          VERSION=$(uv version --short)
          echo "ğŸ“¦ Tag: $TAG"
          echo "ğŸ“¦ Version: $VERSION"

      - name: æ„å»ºåŒ…
        run: uv build

      - name: å‘å¸ƒåˆ° Test-PyPI
        env:
          UV_PUBLISH_TOKEN: ${{ secrets.TEST_PYPI_API_TOKEN }}
        run: uv publish --index testpypi
