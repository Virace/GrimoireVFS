# 发布到 PyPI 生产环境
# 触发条件: 创建 GitHub Release
# 
# 流程:
#   1. 从 Release tag (如 v0.2.0) 提取版本号
#   2. 自动更新 pyproject.toml 中的版本为正式版 (移除 .dev 后缀)
#   3. 运行测试 → 构建 → 发布到 PyPI

name: Publish to PyPI

on:
  release:
    types: [published]

permissions:
  contents: write  # 需要写权限来更新版本号

jobs:
  # 发布前运行测试确保代码质量
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: 安装 uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true

      - name: 安装依赖
        run: uv sync --group dev

      - name: 运行测试
        run: uv run pytest -v

  # 构建并发布
  publish:
    needs: test
    runs-on: ubuntu-latest
    permissions:
      id-token: write  # Trusted Publishing 必需
      contents: write

    environment:
      name: pypi
      url: https://pypi.org/project/grimoirevfs/

    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: 安装 uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true

      - name: 从 Release tag 提取并设置版本号
        id: version
        run: |
          # 从 tag 提取版本号 (v0.2.0 -> 0.2.0)
          TAG_NAME="${{ github.event.release.tag_name }}"
          VERSION="${TAG_NAME#v}"
          echo "从 tag 提取版本: $VERSION"
          
          # 设置为正式版本
          uv version $VERSION --no-sync
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: 提交版本更新
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add pyproject.toml uv.lock
          git diff --staged --quiet || git commit -m "chore: release version ${{ steps.version.outputs.version }} [skip ci]"
          git push

      - name: 构建发布包
        run: uv build

      - name: 发布到 PyPI
        run: uv publish
        # 使用 Trusted Publishing，无需 token
        # 如果未配置 Trusted Publishing，请取消下面的注释并设置 secret
        # env:
        #   UV_PUBLISH_TOKEN: ${{ secrets.PYPI_API_TOKEN }}
