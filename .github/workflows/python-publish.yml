# 发布到 PyPI 生产环境
#
# 触发条件: 创建 GitHub Release
#
# 使用方法:
#   1. 确保 pyproject.toml 中的版本号是正式版 (如 0.2.0，不带 dev/a/b/rc 后缀)
#   2. git commit + push
#   3. 在 GitHub 上创建 Release (tag: v0.2.0)
#   4. 工作流自动运行测试并发布到 PyPI

name: Publish to PyPI

on:
  release:
    types: [published]

permissions:
  contents: read

# 防止多个发布同时运行
concurrency:
  group: pypi-publish
  cancel-in-progress: false

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: 安装 uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true

      - name: 安装 rclone
        run: |
          curl https://rclone.org/install.sh | sudo bash
          rclone version

      - name: 安装 fhash
        run: |
          FHASH_VERSION=$(curl -s https://api.github.com/repos/Virace/fast-hasher/releases/latest | grep -oP '"tag_name": "\K[^"]+')
          echo "安装 fhash ${FHASH_VERSION}"
          sudo curl -L "https://github.com/Virace/fast-hasher/releases/download/${FHASH_VERSION}/fhash-linux-amd64" -o /usr/local/bin/fhash
          sudo chmod +x /usr/local/bin/fhash
          fhash -v

      - name: 安装依赖
        run: uv sync --group dev

      - name: 运行测试
        run: uv run pytest -v

  publish:
    needs: test
    runs-on: ubuntu-latest
    permissions:
      id-token: write  # Trusted Publishing 必需

    environment:
      name: pypi
      url: https://pypi.org/project/grimoirevfs/

    steps:
      - uses: actions/checkout@v4

      - name: 安装 uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true

      - name: 验证版本号
        run: |
          VERSION=$(uv version --short)
          TAG="${{ github.event.release.tag_name }}"
          TAG_VERSION="${TAG#v}"
          
          echo "pyproject.toml 版本: $VERSION"
          echo "Release tag 版本: $TAG_VERSION"
          
          if [[ "$VERSION" != "$TAG_VERSION" ]]; then
            echo "❌ 错误: 版本号不匹配！"
            echo "请确保 pyproject.toml 中的版本号与 Release tag 一致"
            exit 1
          fi
          
          echo "✅ 版本号验证通过"

      - name: 构建发布包
        run: uv build

      - name: 发布到 PyPI
        run: uv publish
        # 使用 Trusted Publishing，无需 token
        # 如果未配置 Trusted Publishing，请取消下面的注释并设置 secret
        # env:
        #   UV_PUBLISH_TOKEN: ${{ secrets.PYPI_API_TOKEN }}
